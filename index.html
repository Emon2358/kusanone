<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‰ã®æ ¹bbs - é«˜æ©Ÿèƒ½P2Pãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    :root {
      --primary-color: #4a86e8;
      --secondary-color: #f5f5f5;
      --success-color: #34a853;
      --warning-color: #fbbc05;
      --danger-color: #ea4335;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
    }
    
    body {
      font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      background: var(--secondary-color);
      margin: 0;
      padding: 0;
      color: var(--dark-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }
    
    header {
      background: var(--primary-color);
      color: white;
      padding: 15px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .connection-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
    }
    
    .status-indicator.online {
      background-color: var(--success-color);
    }
    
    #myId {
      font-weight: bold;
      background: var(--light-color);
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    .connection-form {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .connection-form input {
      flex: 1;
    }
    
    .chat-container {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      height: 400px;
    }
    
    .online-users {
      width: 200px;
      background: white;
      border-radius: 5px;
      padding: 10px;
      overflow-y: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .online-users h3 {
      margin-top: 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .user-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    
    .user-list li {
      padding: 8px 5px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    
    .user-list li:hover {
      background-color: var(--light-color);
    }
    
    .user-list li.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    #chat {
      flex: 1;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      overflow-y: auto;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message {
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 18px;
      max-width: 70%;
      word-break: break-word;
      position: relative;
    }
    
    .message .time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 3px;
    }
    
    .you {
      background: #e3f2fd;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }
    
    .peer {
      background: #f1f1f1;
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }
    
    .system {
      background: #fff3e0;
      margin: 10px auto;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
    }
    
    .message-form {
      display: flex;
      gap: 10px;
    }
    
    input, button, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    input:focus, button:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #3b78e7;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .toolbar button {
      padding: 5px 10px;
      font-size: 14px;
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      z-index: 100;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .emoji-btn {
      cursor: pointer;
      font-size: 20px;
      padding: 5px;
      border-radius: 4px;
      text-align: center;
    }
    
    .emoji-btn:hover {
      background: var(--light-color);
    }
    
    .hidden {
      display: none;
    }
    
    .typing-indicator {
      font-style: italic;
      color: #666;
      font-size: 14px;
      padding: 5px 15px;
    }
    
    .file-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 5px 0;
      border-radius: 5px;
    }
    
    footer {
      text-align: center;
      padding: 15px;
      background: var(--dark-color);
      color: white;
      font-size: 14px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      .chat-container {
        flex-direction: column;
        height: auto;
      }
      
      .online-users {
        width: auto;
        height: 150px;
      }
      
      #chat {
        height: 350px;
      }
      
      .connection-form {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>è‰ã®æ ¹bbs - é«˜æ©Ÿèƒ½P2Pãƒãƒ£ãƒƒãƒˆ</h1>
  </header>
  
  <div class="container">
    <div class="status-bar">
      <div class="connection-info">
        <div>
          <span class="status-indicator" id="statusIndicator"></span>
          <span id="statusText">æœªæ¥ç¶š</span>
        </div>
        <div>
          ID: <span id="myId" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">å–å¾—ä¸­...</span>
        </div>
      </div>
      
      <div>
        <select id="roomSelect">
          <option value="public">å…¬é–‹ãƒãƒ£ãƒƒãƒˆ</option>
          <option value="private">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒƒãƒˆ</option>
        </select>
      </div>
    </div>
    
    <div class="connection-form">
      <input type="text" id="peerIdInput" placeholder="ç›¸æ‰‹ã®Peer IDã‚’å…¥åŠ›">
      <button id="connectBtn">æ¥ç¶š</button>
      <button id="disconnectBtn">åˆ‡æ–­</button>
    </div>
    
    <div class="toolbar">
      <button id="clearBtn">å±¥æ­´æ¶ˆå»</button>
      <button id="saveBtn">ãƒãƒ£ãƒƒãƒˆä¿å­˜</button>
      <input type="color" id="colorPicker" value="#4a86e8" title="è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‰²">
    </div>
    
    <div class="chat-container">
      <div class="online-users">
        <h3>æ¥ç¶šä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
        <ul class="user-list" id="userList">
          <li>ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“</li>
        </ul>
      </div>
      
      <div id="chat">
        <div class="message system">ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚æ¥ç¶šã™ã‚‹ã«ã¯ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ã‚ãªãŸã®IDã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    </div>
    
    <div id="typingIndicator" class="typing-indicator hidden"></div>
    
    <div class="message-form">
      <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
      <button id="emojiBtn" title="çµµæ–‡å­—">ğŸ˜Š</button>
      <button id="fileBtn" title="ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡">ğŸ“</button>
      <input type="file" id="fileInput" style="display: none">
      <button id="sendBtn">é€ä¿¡</button>
    </div>
    
    <div id="emojiPicker" class="emoji-picker hidden"></div>
  </div>
  
  <footer>
    <p>è‰ã®æ ¹bbs P2Pãƒãƒ£ãƒƒãƒˆ v2.0 - WebRTCæŠ€è¡“ã§å®‰å…¨ãªç›´æ¥é€šä¿¡</p>
  </footer>
  
  <!-- PeerJS ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let peer;
    let connections = {}; // ã™ã¹ã¦ã®æ¥ç¶šã‚’ä¿å­˜
    let currentRoom = 'public'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ 
    let username = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' + Math.floor(Math.random() * 1000);
    let isTyping = false;
    let typingTimeout;
    const emojis = ['ğŸ˜Š','ğŸ˜‚','ğŸ˜','ğŸ‘','ğŸ‰','â¤ï¸','ğŸ˜','ğŸ™Œ','ğŸ¤”','ğŸ˜¢','ğŸ˜¡','ğŸ¥º','ğŸ‘','ğŸ”¥','âœ¨','ğŸ’¯','ğŸŒŸ','ğŸ¤©','ğŸ‘‹','ğŸ™'];
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', initialize);
    
    function initialize() {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å°‹ã­ã‚‹
      const savedUsername = localStorage.getItem('p2p-username');
      if (savedUsername) {
        username = savedUsername;
      } else {
        const userInput = prompt('ãƒãƒ£ãƒƒãƒˆã§ã®è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', username);
        if (userInput && userInput.trim() !== '') {
          username = userInput.trim();
          localStorage.setItem('p2p-username', username);
        }
      }
      
      // PeerJSã®è¨­å®š
      const peerOptions = {
        debug: 1,
        config: {
          'iceServers': [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        }
      };
      
      // PeerJSã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
      peer = new Peer(null, peerOptions);
      
      // è‡ªåˆ†ã®Peer IDã‚’å–å¾—
      peer.on('open', function(id) {
        document.getElementById('myId').textContent = id;
        document.getElementById('statusIndicator').classList.add('online');
        document.getElementById('statusText').textContent = 'æ¥ç¶šå¯èƒ½';
        addSystemMessage(`ã‚ˆã†ã“ãï¼ã‚ãªãŸã®IDã¯ ${id} ã§ã™ã€‚`);
      });
      
      // æ¥ç¶šã‚¨ãƒ©ãƒ¼
      peer.on('error', function(err) {
        console.error('PeerJS error:', err);
        addSystemMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.type}`);
        
        if (err.type === 'peer-unavailable') {
          addSystemMessage('æŒ‡å®šã•ã‚ŒãŸIDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        } else if (err.type === 'disconnected') {
          document.getElementById('statusIndicator').classList.remove('online');
          document.getElementById('statusText').textContent = 'åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ';
        }
      });
      
      // ä»–ã®ãƒ”ã‚¢ã‹ã‚‰æ¥ç¶šãŒæ¥ãŸå ´åˆ
      peer.on('connection', handleIncomingConnection);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      setupEventListeners();
      
      // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã®åˆæœŸåŒ–
      initEmojiPicker();
    }
    
    function setupEventListeners() {
      // æ¥ç¶šãƒœã‚¿ãƒ³
      document.getElementById('connectBtn').addEventListener('click', connectToPeer);
      
      // åˆ‡æ–­ãƒœã‚¿ãƒ³
      document.getElementById('disconnectBtn').addEventListener('click', disconnectAll);
      
      // ãƒ«ãƒ¼ãƒ é¸æŠ
      document.getElementById('roomSelect').addEventListener('change', function() {
        currentRoom = this.value;
        addSystemMessage(`${currentRoom === 'public' ? 'å…¬é–‹' : 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'}ãƒãƒ£ãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);
      });
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        } else {
          sendTypingIndicator();
        }
      });
      
      // å±¥æ­´æ¶ˆå»
      document.getElementById('clearBtn').addEventListener('click', function() {
        if (confirm('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
          document.getElementById('chat').innerHTML = '';
          addSystemMessage('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã—ãŸ');
        }
      });
      
      // ãƒãƒ£ãƒƒãƒˆä¿å­˜
      document.getElementById('saveBtn').addEventListener('click', saveChat);
      
      // è‡ªåˆ†ã®IDã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ”ãƒ¼
      document.getElementById('myId').addEventListener('click', function() {
        navigator.clipboard.writeText(this.textContent)
          .then(() => {
            addSystemMessage('IDã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          })
          .catch(err => {
            console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
          });
      });
      
      // çµµæ–‡å­—ãƒœã‚¿ãƒ³
      document.getElementById('emojiBtn').addEventListener('click', function() {
        const picker = document.getElementById('emojiPicker');
        picker.classList.toggle('hidden');
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ãƒœã‚¿ãƒ³
      document.getElementById('fileBtn').addEventListener('click', function() {
        document.getElementById('fileInput').click();
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    }
    
    function handleIncomingConnection(conn) {
      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
      conn.on('open', function() {
        // æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜
        connections[conn.peer] = conn;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’é€ä¿¡
        conn.send({
          type: 'info',
          username: username,
          room: currentRoom
        });
        
        addSystemMessage(`${conn.peer} ã‹ã‚‰æ¥ç¶šã•ã‚Œã¾ã—ãŸ`);
        updateUserList();
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚
        conn.on('data', function(data) {
          handleReceivedData(conn.peer, data);
        });
        
        // åˆ‡æ–­æ™‚
        conn.on('close', function() {
          delete connections[conn.peer];
          addSystemMessage(`${conn.peer} ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ`);
          updateUserList();
        });
      });
    }
    
    function connectToPeer() {
      const peerId = document.getElementById('peerIdInput').value.trim();
      if (peerId === '') {
        alert('ç›¸æ‰‹ã®Peer IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      if (connections[peerId]) {
        alert('ã™ã§ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™ã€‚');
        return;
      }
      
      const conn = peer.connect(peerId, {
        reliable: true,
        metadata: {
          username: username,
          room: currentRoom
        }
      });
      
      addSystemMessage(`${peerId} ã«æ¥ç¶šã—ã¦ã„ã¾ã™...`);
      
      conn.on('open', function() {
        // æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜
        connections[conn.peer] = conn;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’é€ä¿¡
        conn.send({
          type: 'info',
          username: username,
          room: currentRoom
        });
        
        addSystemMessage(`${conn.peer} ã¨ã®æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ`);
        updateUserList();
        
        // æ¥ç¶šå¾Œãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('peerIdInput').value = '';
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚
        conn.on('data', function(data) {
          handleReceivedData(conn.peer, data);
        });
        
        // åˆ‡æ–­æ™‚
        conn.on('close', function() {
          delete connections[conn.peer];
          addSystemMessage(`${conn.peer} ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ`);
          updateUserList();
        });
      });
      
      conn.on('error', function(err) {
        addSystemMessage(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${err}`);
      });
    }
    
    function handleReceivedData(peerId, data) {
      // ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã«å¿œã˜ã¦å‡¦ç†
      if (typeof data === 'string') {
        // å˜ç´”ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        addMessage('peer', data, peerId);
      } else if (data.type === 'typing') {
        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
        showTypingIndicator(data.username);
      } else if (data.type === 'info') {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        connections[peerId].username = data.username;
        updateUserList();
      } else if (data.type === 'file') {
        // ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡
        receiveFile(data, peerId);
      }
    }
    
    function addMessage(type, message, peerId = null) {
      const chatDiv = document.getElementById('chat');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (type === 'you' ? 'you' : 'peer');
      
      if (type === 'you') {
        const color = document.getElementById('colorPicker').value;
        msgDiv.style.backgroundColor = color;
        msgDiv.style.color = isLightColor(color) ? '#000' : '#fff';
      }
      
      // é€ä¿¡è€…åã‚’è¡¨ç¤ºï¼ˆç›¸æ‰‹ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆï¼‰
      if (type === 'peer' && peerId && connections[peerId]) {
        const peerName = connections[peerId].username || peerId.substring(0, 6);
        const nameSpan = document.createElement('div');
        nameSpan.textContent = peerName;
        nameSpan.style.fontWeight = 'bold';
        nameSpan.style.fontSize = '12px';
        nameSpan.style.marginBottom = '3px';
        msgDiv.appendChild(nameSpan);
      }
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
      const messageContent = document.createElement('div');
      
      // URLã‚’æ¤œå‡ºã—ã¦ãƒªãƒ³ã‚¯ã«å¤‰æ›
      const messageWithLinks = message.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
      
      messageContent.innerHTML = messageWithLinks;
      msgDiv.appendChild(messageContent);
      
      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
      const timeSpan = document.createElement('div');
      timeSpan.className = 'time';
      const now = new Date();
      timeSpan.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      msgDiv.appendChild(timeSpan);
      
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      
      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
      hideTypingIndicator();
    }
    
    function addSystemMessage(message) {
      const chatDiv = document.getElementById('chat');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message system';
      msgDiv.textContent = message;
      
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
    
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (message === '') return;
      
      if (Object.keys(connections).length === 0) {
        addSystemMessage('æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ãƒ”ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      
      // ã™ã¹ã¦ã®æ¥ç¶šã«é€ä¿¡
      for (const id in connections) {
        const conn = connections[id];
        if (conn.open) {
          conn.send(message);
        }
      }
      
      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      addMessage('you', message);
      input.value = '';
      
      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      clearTimeout(typingTimeout);
      isTyping = false;
    }
    
    function disconnectAll() {
      for (const id in connections) {
        connections[id].close();
      }
      
      connections = {};
      addSystemMessage('ã™ã¹ã¦ã®æ¥ç¶šã‚’åˆ‡æ–­ã—ã¾ã—ãŸ');
      updateUserList();
    }
    
    function updateUserList() {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      
      if (Object.keys(connections).length === 0) {
        const li = document.createElement('li');
        li.textContent = 'ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“';
        userList.appendChild(li);
        return;
      }
      
      for (const id in connections) {
        const li = document.createElement('li');
        const username = connections[id].username || id.substring(0, 6);
        li.textContent = username;
        li.title = id;
        userList.appendChild(li);
      }
    }
    
    function initEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      
      emojis.forEach(emoji => {
        const btn = document.createElement('div');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.addEventListener('click', function() {
          const input = document.getElementById('messageInput');
          input.value += emoji;
          input.focus();
          picker.classList.add('hidden');
        });
        
        picker.appendChild(btn);
      });
      
      // çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
      document.addEventListener('click', function(event) {
        if (!picker.contains(event.target) && event.target.id !== 'emojiBtn') {
          picker.classList.add('hidden');
        }
      });
    }
    
    function sendTypingIndicator() {
      if (!isTyping) {
        isTyping = true;
        
        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹ã‚’é€ä¿¡
        for (const id in connections) {
          const conn = connections[id];
          if (conn.open) {
            conn.send({
              type: 'typing',
              username: username
            });
          }
        }
      }
      
      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(function() {
        isTyping = false;
      }, 2000);
    }
    
    function showTypingIndicator(user) {
      const indicator = document.getElementById('typingIndicator');
      indicator.textContent = `${user} ãŒå…¥åŠ›ä¸­...`;
      indicator.classList.remove('hidden');
      
      // 3ç§’å¾Œã«éè¡¨ç¤º
      setTimeout(function() {
        indicator.classList.add('hidden');
      }, 3000);
    }
    
    function hideTypingIndicator() {
      document.getElementById('typingIndicator').classList.add('hidden');
    }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (5MBåˆ¶é™)
      if (file.size > 5 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const fileData = {
          type: 'file',
          name: file.name,
          data: e.target.result,
          mimeType: file.type
        };
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆç”»åƒã®å ´åˆï¼‰
        if (file.type.startsWith('image/')) {
          const input = document.getElementById('messageInput');
          input.value = `[ç”»åƒ: ${file.name}]`;
        } else {
          const input = document.getElementById('messageInput');
          input.value = `[ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}]`;
        }
        
        // ã™ã¹ã¦ã®æ¥ç¶šã«é€ä¿¡
        for (const id in connections) {
          const conn = connections[id];
          if (conn.open) {
            conn.send(fileData);
          }
        }
        
        // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦ã‚‚è¡¨ç¤º
        sendMessage();
      };
      
      reader.readAsDataURL(file);
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
    }
    
    function receiveFile(data, peerId) {
      const chatDiv = document.getElementById('chat');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message peer';
      
      // é€ä¿¡è€…å
      if (connections[peerId]) {
        const peerName = connections[peerId].username || peerId.substring(0, 6);
        const nameSpan = document.createElement('div');
        nameSpan.textContent = peerName;
        nameSpan.style.fontWeight = 'bold';
        nameSpan.style.fontSize = '12px';
        nameSpan.style.marginBottom = '3px';
        msgDiv.appendChild(nameSpan);
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
      const fileInfo = document.createElement('div');
      fileInfo.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«: ${data.name}`;
      msgDiv.appendChild(fileInfo);
      
      // ç”»åƒã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      if (data.mimeType.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = data.data;
        img.alt = data.name;
        img.className = 'file-preview';
        msgDiv.appendChild(img);
      }
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯
      const link = document.createElement('a');
      link.href = data.data;
      link.download = data.name;
      link.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
      link.style.display = 'block';
      link.style.marginTop = '5px';
      link.style.color = '#4a86e8';
      msgDiv.appendChild(link);
      
      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
      const timeSpan = document.createElement('div');
      timeSpan.className = 'time';
      const now = new Date();
      timeSpan.textContent = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      msgDiv.appendChild(timeSpan);
      
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
    
    function saveChat() {
      const chatContent = document.getElementById('chat').innerHTML;
      const blob = new Blob([`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>P2Pãƒãƒ£ãƒƒãƒˆå±¥æ­´</title>
          <style>
            body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
            .message { padding: 8px 12px; margin: 8px 0; border-radius: 18px; }
            .you { background: #e3f2fd; margin-left: auto; text-align: right; }
            .peer { background: #f1f1f1; margin-right: auto; }
            .system { background: #fff3e0; margin: 10px auto; text-align: center; }
          </style>
        </head>
        <body>
